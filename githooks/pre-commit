#!/bin/bash

echo "=== Running Git Hook: pre-commit ==="

# Check if any Python files are staged
FILES=$(git diff --cached --name-only | grep '\.py$')

if [ "$FILES" != "" ]; then
    echo "üõ°Ô∏è Python files staged. Running Bandit..."

    # Default Bandit path (Linux/macOS)
    BANDIT="./.venv/bin/bandit"

    # Windows Git Bash path
    if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" || "$OSTYPE" == "cygwin" ]]; then
        BANDIT="./.venv/Scripts/bandit.exe"
    fi

    # Check if Bandit exists
    if [ ! -f "$BANDIT" ]; then
        echo "‚ùå Bandit not found in .venv. Please run 'pip install bandit' inside the virtual environment."
        exit 1
    fi

    # Run Bandit using YAML config for exclusions
    echo "üìÇ Running Bandit with bandit.yaml config..."
    "$BANDIT" -r . -f csv -o bandit_report.csv -c bandit.yaml

    # Verify report creation
    if [ -f bandit_report.csv ]; then
        echo "‚úÖ Bandit scan complete. Report saved to bandit_report.csv"
    else
        echo "‚ùå Bandit report not created. Check permissions or config."
        exit 1
    fi
else
    echo "‚ö†Ô∏è No Python files staged. Skipping Bandit scan."
fi
